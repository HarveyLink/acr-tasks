version: 1.0-preview-1
secrets:
  - id: sasurl
    akv: https://myacbvault.vault-int.azure-int.net/secrets/website-sasurl
  - id: name
    akv: https://myacbvault.vault-int.azure-int.net/secrets/demo-name
steps:
  - build: -t curl -f curl.dockerfile .
  - cmd: curl -f -o ./website.tar.gz -sSL https://mgmtdogfood21.blob.core.windows.net/temp/mywebsite.tar.gz?sp=r&st=2019-04-09T23:36:18Z&se=2019-05-01T07:36:18Z&spr=https&sv=2018-03-28&sig=rXVNbI1KCOktaDZFo4cO3SnUVZOSHeF%2FpTkVbE9Dclk%3D&sr=b;
  - cmd: bash tar xf ./website.tar.gz
  - build: -t {{.Run.Registry}}/my-website:{{.Run.ID}} aci-helloworld --build-arg MY_NAME={{.Secrets.name}} -f aci-helloworld/Dockerfile
  - push: ["{{.Run.Registry}}/my-website:{{.Run.ID}}"]
  - cmd: microsoft/azure-cli az cloud register -n dogfood --endpoint-active-directory https://login.windows-ppe.net --endpoint-active-directory-graph-resource-id https://graph.ppe.windows.net/ --endpoint-active-directory-resource-id https://management.core.windows.net/ --endpoint-gallery https://current.gallery.azure-test.net/ --endpoint-management https://management.core.windows.net/ --endpoint-resource-manager https://api-dogfood.resources.windows-int.net/ --suffix-storage-endpoint core.test-cint.azure-test.net 
  - cmd: microsoft/azure-cli az cloud set -n dogfood 
  - cmd: microsoft/azure-cli az login --identity
  - cmd: microsoft/azure-cli az container create -g vstools -n mycontainer --image {{.Run.Registry}}/my-website:{{.Run.ID}} --dns-name-label msii-demo --ports 80 -l eastus --registry-login-server {{.Run.Registry}} --registry-username samashahtest --registry-password DxUheRj1srMIyxs=kfPrPIqHtNkKKExI --assign-identity [system]
