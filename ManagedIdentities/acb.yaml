version: 1.0-preview-1
secrets:
  - id: sasurl
    akv: https://myacbvault.vault-int.azure-int.net/secrets/website-sasurl
  - id: name
    akv: https://myacbvault.vault-int.azure-int.net/secrets/demo-name
steps:
  - cmd: bash echo Storage URL is {{.Secrets.sasurl}}
  - cmd: bash echo Secret name is {{.Secrets.name}}
  - build: -t curl -f curl.dockerfile .
  - cmd: curl -f -o ./website.tar.gz -sSL {{.Secrets.sasurl}}
  - cmd: bash tar xf ./website.tar.gz
  - build: -t {{.Run.Registry}}/my-website:{{.Run.ID}} aci-helloworld --build-arg MY_NAME={{.Secrets.name}} -f aci-helloworld/Dockerfile
  - build: -t someimage:{{.Run.ID}} aci-helloworld --build-arg MY_NAME={{.Secrets.name}} -f aci-helloworld/Dockerfile
  - push: ["{{.Run.Registry}}/my-website:{{.Run.ID}}"]
  - cmd: microsoft/azure-cli az login --identity
  - cmd: microsoft/azure-cli az container create -g vstools -n mycontainer --image someimage:{{.Run.ID}} --dns-name-label msii-demo --ports 80 -l eastus
